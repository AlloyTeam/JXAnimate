<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>jx/jx.ui.sortables.js</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title=""></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: </em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/JXAnimation.Audio.html">JXAnimation.Audio</a></li>
            
                <li><a href="../classes/Log.html">Log</a></li>
            
                <li><a href="../classes/Tab.html">Tab</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/JXAnimate.Audio.html">JXAnimate.Audio</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: jx/jx.ui.sortables.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/**
 * 多容器拖拽排序
 * tealin, 2010-9-21
 */
Jx().$package(function (J) {
    var $D = J.dom,
        $E = J.event;
    var _workAreaWidth=false,
        _workAreaHeight=false,
        _width=false,
        _height=false;
    var curDragElementX, curDragElementY, dragStartX, dragStartY;
    J.ui = J.ui || {};
    /**
     * 拖拽排序封装
     * @class
     * @constructor
     * @memberOf ui
     * @name Sortables
     * @param dropTargets 需要拖拽排序的容器列表
     * @param str 排序后需要返回的字段
     
     */
    J.ui.Sortables = new J.Class(
    /**
     * @lends ui.Sortables.prototype
     */
    {
        /**
         * @ignore
         */
        init : function(dropTargets,sortStr,option){
            this.dropTargets=dropTargets.concat();
            this.sortStr=sortStr;
            this.option = option||{};
            this.limiteOption = this.option.limiteOption||{};
            this.dragController = {};
            this._isLock = false;
        },
        /**
         * 添加拖拽目标容器
         * @param {Object} targetObj targetObj = {el:HTMLElement,level:n} level越大，优先级越高
         */
        addDropTarget : function(targetObj){//targetObj = {el:HTMLElement,level:n} level越大，优先级越高
            this.dropTargets.push(targetObj);
        },
        /**
         * 设置一个dom节点, 用于展现拖拽效果
         * @param {HTMLElement} el
         */
        addEffect : function(el){
            this.effectEl = el;
        },
        /**
         * 移除一个拖拽目标容器
         * @param {HTMLElement} el
         */
        removeDropTarget : function(el){
            J.array.remove(this.dropTargets,el);
        },
        /**
         * 刷新拖拽目标容器, 更新其坐标
         */
        refreshDropTarget : function(target){
            var targetPos,
                xy,
                targetWidth,
                dropTargets = this.dropTargets,
                targetHeight;
            this.dropPos = [];
            if(!target){
                for(var i in dropTargets){
                    target = dropTargets[i].el;
                    targetPos = {};
                    xy = $D.getXY(target);
                    targetWidth = $D.getClientWidth(target);
                    targetHeight = $D.getClientHeight(target);
                    targetPos.x = xy[0];
                    targetPos.y = xy[1];
                    targetPos.w = targetWidth;
                    targetPos.h = targetHeight;
                    this.dropPos[i] = targetPos;
                }
            }else{
                for(var i in dropTargets){
                    dropTargetEl = dropTargets[i].el;
                    if(target.el === dropTargetEl){
                        targetPos = {};
                        xy = $D.getXY(dropTargetEl);
                        targetWidth = $D.getClientWidth(dropTargetEl);
                        targetHeight = $D.getClientHeight(dropTargetEl);
                        targetPos.x = xy[0];
                        targetPos.y = xy[1];
                        targetPos.w = targetWidth;
                        targetPos.h = targetHeight;
                        this.dropPos[i] = targetPos;
                        break;
                    }
                }
            }
        },
        /**
         * 添加一个被拖拽节点, 添加之后即可鼠标拖动该元素
         * @param {HTMLElement} el
         */
        addDragClass : function(el){
            var parentEl = el.parentNode, 
                apperceiveEl = el,
//              effectEl =this.effectEl||this.clone(apperceiveEl),//转移到beforeStart里创建
                effectEl = false,
                context = this,
                currentDropTarget = null,
                xyP = $D.getXY(parentEl),//父节点
                xyS = $D.getXY(apperceiveEl),
                addId = el.getAttribute(this.sortStr)||&quot;&quot;,
                dropTargets = this.dropTargets,
                nextEl,
                preXY;//子节点
            
//          //获取模型的体积
//          var _width = $D.getClientWidth(apperceiveEl);
//          var _height = $D.getClientHeight(apperceiveEl);
//          var margin ={}; 
//              margin.top= parseInt($D.getStyle(apperceiveEl,&quot;marginTop&quot;)||0);
//              margin.buttom= parseInt($D.getStyle(apperceiveEl,&quot;marginbottom&quot;)||0);
//              margin.left= parseInt($D.getStyle(apperceiveEl,&quot;marginLeft&quot;)||0);
//              margin.right= parseInt($D.getStyle(apperceiveEl,&quot;marginRight&quot;)||0);
//          //修正盒子模型
//          _width += (margin.left+margin.right);
//          _height += (margin.top+margin.buttom);

            this.dropPos = [];
            var onDragBeforeStart = function(){
                _width = $D.getClientWidth(apperceiveEl);
                _height = $D.getClientHeight(apperceiveEl);
                var margin ={}; 
                margin.top= parseInt($D.getStyle(apperceiveEl,&quot;marginTop&quot;)||0);
                margin.buttom= parseInt($D.getStyle(apperceiveEl,&quot;marginbottom&quot;)||0);
                margin.left= parseInt($D.getStyle(apperceiveEl,&quot;marginLeft&quot;)||0);
                margin.right= parseInt($D.getStyle(apperceiveEl,&quot;marginRight&quot;)||0);
                //修正盒子模型
                _width += (margin.left+margin.right);
                _height += (margin.top+margin.buttom);
                //重新赋值,因为dropTarget是动态添加的
                dropTargets = this.dropTargets;
                //az 2011-6-8
                effectEl = context.effectEl || context.clone(apperceiveEl);
                context.dragController[addId].setEffect(effectEl);
                //重新设置XY.这里不能在dragstart设置,因为在发出start之前已经用了这个高度
                setStartXY();
                this.refreshDropTarget();
                //储存下个一个节点,以便恢复
                parentEl = apperceiveEl.parentNode;
                nextEl = apperceiveEl.nextSibling;
                
                document.body.appendChild(effectEl);
                
                $E.notifyObservers(context, &quot;beforeStart&quot;);
            };
            var onDragStart = function(option){
                currentDropTarget = null;
                if(context.option.isDash){
                    apperceiveEl = context.cloneDashedEl(apperceiveEl);
                }else{
                    if(!J.browser.ie){
                        //$D.setStyle(apperceiveEl,&quot;opacity&quot;,0.5);
                        $D.addClass(apperceiveEl,&quot;ui_halfOpacity&quot;);
                    }
                }
                //J.out(&quot;drag开始&quot;);
                $E.notifyObservers(context, &quot;start&quot;);
            };
            var onDragMove = function(option){
                var moveEvent = option.orientEvent;
                var moveX = moveEvent.pageX;
                var moveY = moveEvent.pageY;
                //减少计算
                if(Math.abs(moveX-preXY[0])+Math.abs(moveY-preXY[1])&lt;1){
                    return;
                }else{
                    if(moveX-preXY[0]&gt;0){
                        var direction = &quot;right&quot;;
                    }else{
                        var direction = &quot;left&quot;;
                    }
                    preXY = [moveX,moveY];
                }
                //父节点宽度
                var hitTarget = {el:null,level:-1,index:0};
                for(var i in this.dropPos){
                    if(
                        (moveX &gt; this.dropPos[i].x)&amp;&amp;
                        (moveX &lt; this.dropPos[i].x + this.dropPos[i].w)&amp;&amp;
                        (moveY &gt; this.dropPos[i].y)&amp;&amp;
                        (moveY &lt; this.dropPos[i].y + this.dropPos[i].h)
                        ){
                            var dropTargetObj = dropTargets[i];
                            var dropTarget = dropTargetObj.el;
                            var parentWidth = $D.getClientWidth(dropTarget);
                            //每行个数
                            var perRow = Math.floor(parentWidth/_width);
                            
                            //容器的XY
                            var dropTargetXY = $D.getXY(dropTarget);
                            //先对于容器的位置
                            var x = moveX - dropTargetXY[0];
                            var y = moveY - dropTargetXY[1];
                            //var fixX = preIndexXY[1]==indexY?(preXY[0]-moveX&gt;0?(-0.3):0.3):0;
                            var indexY = Math.floor(y/_height);
                            if(direction==&quot;right&quot;){
                                var indexX = Math.ceil(x/_width);
                            }else if(direction==&quot;left&quot;){
                                var indexX = Math.floor(x/_width);
                            }
                            
                            var index = indexX+indexY*perRow;
                            if(hitTarget.level &lt;dropTargetObj.level){
                                hitTarget.level = dropTargetObj.level;
                                hitTarget.el = dropTargetObj.el;
                                hitTarget.index = index;
                            }
                            /*
                            if(dropTarget.getAttribute(&#x27;customAcceptDrop&#x27;)){
                                $E.notifyObservers(dropTarget,&#x27;dragmove&#x27;,option);
                                break;
                            }
                            
                            
                            
                            //修正IE下index找不到的时候插不到最后一个的错误
                            if(dropTarget.childNodes[index]){
                                dropTarget.insertBefore(apperceiveEl,dropTarget.childNodes[index]);
                            }else{
                                dropTarget.appendChild(apperceiveEl);
                            }
                            break;
                            */
                    }
                }
                currentDropTarget = hitTarget.el
                if(currentDropTarget){
                    if(currentDropTarget.getAttribute(&#x27;customAcceptDrop&#x27;)){
                        $E.notifyObservers(currentDropTarget,&#x27;dragmove&#x27;,option);
                    }else if(currentDropTarget.childNodes[index]){//修正IE下index找不到的时候插不到最后一个的错误
                        currentDropTarget.insertBefore(apperceiveEl,currentDropTarget.childNodes[index]);
                    }else{
                        currentDropTarget.appendChild(apperceiveEl);
                    }
                }
//              try{
                    $E.notifyObservers(context, &quot;move&quot;,option);
//              }catch(e){
//                  J.out(&quot;move error&quot;);
//              }
            };
            var onDragOverFlow = function(option){
                option.el=effectEl;
                $E.notifyObservers(context, &quot;overFlowBorder&quot;,option);
            };
            var onDragEnd = function(option){
                var moveEvent = option.orientEvent;
                var moveX = moveEvent.pageX;
                var moveY = moveEvent.pageY;
                if(currentDropTarget &amp;&amp; currentDropTarget.getAttribute &amp;&amp;currentDropTarget.getAttribute(&#x27;customAcceptDrop&#x27;)){
                    $E.notifyObservers(currentDropTarget, &quot;drop&quot;,{&#x27;dragEl&#x27;:el,&quot;queue&quot;:queue,&quot;pos&quot;:{x:moveX,y:moveY},&quot;apperceiveEl&quot;:apperceiveEl,&quot;nextEl&quot;:nextEl,&quot;parentEl&quot;:parentEl,&quot;currentDropTarget&quot;:currentDropTarget});
                }
                document.body.removeChild(effectEl);
                if(context.option.isDash){
                    context.removeDashedEl();
                    apperceiveEl = context.tempEl;
                }else{
                    if(!J.browser.ie){
                        //$D.setStyle(apperceiveEl,&quot;opacity&quot;,1);
                        $D.removeClass(apperceiveEl,&quot;ui_halfOpacity&quot;);
                    }                   
                }
                //返回队列
                var queue = [];
                for(var i in dropTargets){
                    queue[i] = [];
                    var childNodes = dropTargets[i].el.childNodes;
                    for(var k=0;k&lt;childNodes.length;k++){
                        var node = childNodes[k];
                        if(!node.getAttribute){
                            break;
                        }
                        var attribute=childNodes[k].getAttribute(context.sortStr);
                        if(attribute){
                            queue[i].push(attribute);
                        }
                    }
                }
                //J.out(&quot;drag结束&quot;);
                try{
                    $E.notifyObservers(context, &quot;end&quot;,{&quot;queue&quot;:queue,&quot;pos&quot;:option,&quot;apperceiveEl&quot;:apperceiveEl,&quot;nextEl&quot;:nextEl,&quot;parentEl&quot;:parentEl});
                }catch(e){
                    J.out(&quot;drop error&quot;);
                }
                var containerEl=document.elementFromPoint(moveX, moveY);
                if(containerEl){
                    $E.notifyObservers(J.ui, &quot;drop&quot;,{&#x27;dragEl&#x27;:el,&quot;pos&quot;:{x:moveX,y:moveY},&quot;apperceiveEl&quot;:apperceiveEl,&quot;dropEl&quot;:containerEl});
                }
            };
            //初始化XY
            var setStartXY = function(){
                //xyP = $D.getXY(parentEl);//父层坐标
                xyS = $D.getXY(apperceiveEl);//子层坐标
                var x = xyS[0];
                var y = xyS[1];
                preXY = [x,y];
                $D.setStyle(effectEl,&quot;left&quot;,x+&quot;px&quot;);
                $D.setStyle(effectEl,&quot;top&quot;,y+&quot;px&quot;);
            };
            
            var initDropPos = function(){//废弃，用refreshDropPos
                var target,
                    targetPos,
                    xy,
                    targetWidth,
                    targetHeight;
                this.dropPos = [];
                for(var i in dropTargets){
                    target = dropTargets[i].el;
                    targetPos = {};
                    xy = $D.getXY(target);
                    targetWidth = $D.getClientWidth(target);
                    targetHeight = $D.getClientHeight(target);
                    targetPos.x = xy[0];
                    targetPos.y = xy[1];
                    targetPos.w = targetWidth;
                    targetPos.h = targetHeight;
                    this.dropPos[i] = targetPos;
                }
            }
            
            this.dragController[addId] = new J.ui.Drag(el,effectEl,this.limiteOption);
            $E.addObserver(this.dragController[addId],&quot;beforeStart&quot;,J.bind(onDragBeforeStart,this));
            $E.addObserver(this.dragController[addId],&quot;start&quot;,J.bind(onDragStart,this));
            $E.addObserver(this.dragController[addId],&quot;move&quot;,J.bind(onDragMove,this));
            $E.addObserver(this.dragController[addId],&quot;overFlowBorder&quot;,J.bind(onDragOverFlow,this));
            $E.addObserver(this.dragController[addId],&quot;end&quot;,J.bind(onDragEnd,this));
        },
        /**
         * 设置拖拽的边界限制
         * @param {Object} option
         * @see ui.Drag#setLimite
         */
        setLimite : function(option){
            for(var i in this.dragController){
                this.dragController[i].setLimite(option);
            }
        },
        /**
         * @private
         */
        cloneDashedEl : function(el){
            var dashedEl = $D.node(&quot;div&quot;);
            var className = this.option.className;
            if(className){
                $D.setClass(dashedEl,className);
            }else{
                $D.setStyle(dashedEl,&quot;border&quot;,&quot;dashed 2px #fff&quot;);
                $D.setClass(dashedEl,el.className);
                $D.setStyle(dashedEl,&quot;position&quot;,&quot;relative&quot;);
                $D.setStyle(dashedEl,&quot;float&quot;,&quot;left&quot;);
                var width = el.offsetWidth - 10 * parseInt(dashedEl.style.borderWidth) + &quot;px&quot;;
                var height = el.offsetHeight - 10 * parseInt(dashedEl.style.borderWidth) + &quot;px&quot;; 
                $D.setStyle(dashedEl,&quot;width&quot;,width);
                $D.setStyle(dashedEl,&quot;height&quot;,height);
            }
            this.dashedEl = dashedEl;
            if (el.nextSibling) {
                el.parentNode.insertBefore(dashedEl, el.nextSibling);
            }
            else {
                el.parentNode.appendChild(dashedEl);
            }
            this.tempEl = el;
            el.parentNode.removeChild(el);
            return dashedEl;
        },
        /**
         * @private
         */
        removeDashedEl : function(){
            if (this.dashedEl.nextSibling) {
                this.dashedEl.parentNode.insertBefore(this.tempEl, this.dashedEl.nextSibling);
            }
            else {
                this.dashedEl.parentNode.appendChild(this.tempEl);
            }
            this.dashedEl.parentNode.removeChild(this.dashedEl);
        },
        /**
         * @private
         */
        clone : function(el){
            var result;
            var jumpOut = false;
            var cloneEl = el.cloneNode(true);
            cloneEl.setAttribute(&quot;id&quot;,&quot;&quot;);
            $D.setStyle(cloneEl,&quot;position&quot;,&quot;absolute&quot;);
            $D.setStyle(cloneEl,&quot;zIndex&quot;,&quot;9999999&quot;);
            $D.setStyle(cloneEl,&quot;background&quot;,&quot;none&quot;);
            return cloneEl;
        },
        /**
         * 锁定, 禁止拖动
         */
        lock: function(){
            this._isLock = true;
            for(var i in this.dragController){
                this.dragController[i].lock();
            }
        },
        /**
         * 解锁, 允许拖动
         */
        unlock: function(){
            this._isLock = false;
            for(var i in this.dragController){
                this.dragController[i].unlock();
            }
        },
        /**
         * 返回是否锁定
         */
        isLock: function(){
            return this._isLock;
        },
        /**
         * @private
         */
        forEachNode : function(arr,fun){
            var len = arr.length;
            if (typeof fun != &quot;function&quot;) {
                throw new TypeError();
            }
            var thisp = arguments[2];
            for (var i = 0; i &lt; len; i++) {
                if (i in arr) {
                    fun.call(thisp, arr[i], i, arr);
                }
            }
        }
        
    });
});

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
