<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>etamina.audio.js</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title=""></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: </em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/animSetting.html">animSetting</a></li>
            
                <li><a href="../classes/JX.Animate.html">JX.Animate</a></li>
            
                <li><a href="../classes/JXAnimation.Audio.html">JXAnimation.Audio</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/JXAnimate.html">JXAnimate</a></li>
            
                <li><a href="../modules/JXAnimate.Audio.html">JXAnimate.Audio</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: etamina.audio.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/* ===========================================================================
 * etamina == animate
 *
 * @description
 * Etamina Audio Library. It can preload and play audio.
 * load this file before etamina.js
 *
 * @author minren 
 * ===========================================================================
 * 
 */

/**
 * @description
 *
 */
etamina.audio = (function () {



	var core = {
		MAX_SOUNDS:10,
		soundRedundancy:2,//每个声音重复加载的次数。频繁重复同一个声音时，增加冗余可以保持播放流畅。
		path:&#x27;&#x27;,
		audioType:false,
		loadCount:0,
		itemsToLoadCount:0,
		itemsToLoad : new Array(),
		soundPool : new Array(),


		supportedAudioFormat : function(audio) {
			var returnExtension = &quot;&quot;;
			if (audio.canPlayType(&quot;audio/ogg&quot;) ==&quot;probably&quot; || audio.canPlayType(&quot;audio/ogg&quot;) == &quot;maybe&quot;) {
				returnExtension = &quot;ogg&quot;;
			} else if(audio.canPlayType(&quot;audio/wav&quot;) ==&quot;probably&quot; || audio.canPlayType(&quot;audio/wav&quot;) == &quot;maybe&quot;) {
				returnExtension = &quot;wav&quot;;
			} else if(audio.canPlayType(&quot;audio/mp3&quot;) == &quot;probably&quot; || audio.canPlayType(&quot;audio/mp3&quot;) == &quot;maybe&quot;) {
				returnExtension = &quot;mp3&quot;;
			}
			
			return returnExtension;
			
		},

		init:function(params){
			params = params||{};
			if(&#x27;path&#x27; in params){
				this.path = params.path;
			}
		},
		preload:function(sounds,redundancy,path){
			if(this.itemsToLoadCount&gt;0){
				return;
			}

			if(etamina.format.isString(sounds)){
				this.preloadSound(sounds,redundancy,path);
				return;
			}
			else if(sounds.length&gt;0){
				var fullname;
				for (var i = sounds.length - 1; i &gt;= 0; i--) {

					var sound = sounds[i];
					
					redundancy = redundancy || this.soundRedundancy;
					path = path|| this.path;
					fullname = path+sound;
					var tempSound;
					for (var j = 0; j &lt;redundancy; j++) {
						this.itemsToLoadCount++;
						tempSound = document.createElement(&quot;audio&quot;);
						if(!this.audioType){
							this.audioType = this.supportedAudioFormat(tempSound);
						}

						tempSound.setAttribute(&quot;src&quot;, fullname + &quot;.&quot; + this.audioType);
						tempSound.addEventListener(&quot;canplaythrough&quot;,this.itemLoaded,false);
						document.body.appendChild(tempSound)
						this.itemsToLoad.push({name:sound, element:tempSound, type:this.audioType, played:false});
					};					
				};
			}
			


		},
		preloadSound:function(sound,redundancy,path){
			if(etamina.format.isString(sound)){
				this.preload([sound],redundancy,path);
				return;
			}
		},
		itemLoaded :  function (event) {
			//TODO：还要考虑加载失败的情况。
			var _audio = etamina.audio;
			_audio.loadCount++;
			if (_audio.loadCount &gt;= _audio.itemsToLoadCount) {
				console.log(&#x27;itemLoaded: total item is &#x27;+_audio.loadCount);
				for (var i = _audio.itemsToLoadCount - 1; i &gt;= 0; i--) {
					item = _audio.itemsToLoad[i];
					item.element.removeEventListener(&quot;canplaythrough&quot;,_audio.itemLoaded,false);
					_audio.soundPool.push(item);
					_audio.itemsToLoad.splice(i,1);
				};
				_audio.itemsToLoadCount=0;
				_audio.loadCount = 0;
			}
		},
		playSound: function(sound,volume){
			volume = volume||1;

			var soundFound = false;
			var soundIndex = 0;
			var tempSound;
			var soundPool = this.soundPool;
			
			if (soundPool.length &gt; 0) {
				console.log(&#x27;play:&#x27;+sound+&#x27;,pool length=&#x27;+soundPool.length)
				while (!soundFound &amp;&amp; soundIndex &lt; soundPool.length) {
				
					var tSound = soundPool[soundIndex];
					if ((tSound.element.ended || !tSound.played) &amp;&amp; tSound.name == sound) {
						soundFound = true;
						tSound.played = true;
					} else {
						soundIndex++;
					}
			
				}
			}
			if (soundFound) {
				tempSound = soundPool[soundIndex].element;
				tempSound.volume = volume;
				tempSound.play();
				
			} else if (soundPool.length &lt; this.MAX_SOUNDS){  //在运行时加载声音，可能会导致停顿。
				/*
				tempSound = document.createElement(&quot;audio&quot;);
				tempSound.setAttribute(&quot;src&quot;, sound + &quot;.&quot; + this.audioType);
				tempSound.volume = volume;
				tempSound.play();
				soundPool.push({name:sound, element:tempSound, type:this.audioType, played:true});
				*/
			}
		}

	};
	return core;
}());
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
