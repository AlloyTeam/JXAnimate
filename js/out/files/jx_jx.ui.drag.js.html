<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>jx/jx.ui.drag.js</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title=""></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: </em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/JXAnimation.Audio.html">JXAnimation.Audio</a></li>
            
                <li><a href="../classes/Log.html">Log</a></li>
            
                <li><a href="../classes/Tab.html">Tab</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/JXAnimate.Audio.html">JXAnimate.Audio</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: jx/jx.ui.drag.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/** 
 * JET (Javascript Extension Tools) 
 * Copyright (c) 2009, KDV.cn, All rights reserved.
 * Code licensed under the BSD License:
 * http://developer.kdv.cn/jet/license.txt
 *
 * @fileOverview Jx!
 * @version 1.0
 * @author  Kinvix(&lt;a href=&quot;mailto:Kinvix@gmail.com&quot;&gt;Kinvix@gmail.com&lt;/a&gt;)
 * @description 
 * 
 */


/** 
 * @description
 * Package: jet.ui
 *
 * Need package:
 * jet.core.js
 * 
 */




/**
 * 拖拽模块
 */
Jx().$package(function (J) {
    var $D = J.dom,
        $E = J.event;

    var ieSelectFix = function (e) {
        e.preventDefault();
        //return false;
    };
    
    var _workAreaWidth=false,
        _workAreaHeight=false,
        _clientWidth,
        _clientHeight,
        _width=false,
        _height=false,
        _limit_right,
        _limit_left,
        _limit_top,
        _limit_bottom;
        
    //for ipad
    var _dragOffsetX,
        _dragOffsetY;
        
    var _dragMaskLayer,
        _maskLayerZIndex = 9000000;
    
    /**
     * 拖拽类
     * 
     * @memberOf ui
     * @class
     * @name Drag
     * @constructor
     * 
     * @param {Element} apperceiveEl 监听拖拽动作的元素
     * @param {Element} effectEl 展现拖拽结果的元素
     * @param {Object} option 其他选项，如:isLimited,leftMargin...
     * 
     * var limiteOption = {
            isLimited : 是否有界限,
            clientEl :盒子模型,边界用
            rightMargin : 边界距离,
            leftMargin : 边界距离,
            bottomMargin : 边界距离,
            topMargin : 边界距离,
            isOverLeft:
            isOverRight:
            isOverTop:
            isOverBottom:能否超出边界,支持拖出去
        };
     */
    J.ui = J.ui || {};
    J.ui.Drag = new J.Class(
    /**
     * @lends ui.Drag.prototype
     */    
    {
        /** @ignore */
        init: function (apperceiveEl, effectEl, option) {
            var context = this;
            var curDragElementX, curDragElementY, dragStartX, dragStartY;
            this.apperceiveEl = apperceiveEl;
            option = option || {};
            this.isLimited = option.isLimited || false;
            this.dragType = option.dragType;
            this.isLocked = option.isLocked || false;
            this.isLockCursorInScreen = option.isLockCursorInScreen || false;
            var isMoved = false;
            if (this.isLimited) {
                this._leftMargin = option.leftMargin || 0;
                this._topMargin = option.topMargin || 0;
                this._rightMargin = option.rightMargin || 0;
                this._bottomMargin = option.bottomMargin || 0;
            }
            if(option.xOnly){
                this._xOnly = option.xOnly||false;
            }
            if(option.yOnly){
                this._yOnly = option.yOnly||false;
            }
            //TODO for flex wmode-non-transparent

            if (effectEl === false) {
                this.effectEl = false;
            } else {
                this.effectEl = effectEl || apperceiveEl;
            }

            /** @ignore */
            this.dragStart = function (e) {
                if(e.changedTouches){//多点触摸
                    if(e.changedTouches.length&gt;1){
                        return;
                    }
                    e=e.changedTouches[0];
                    document.body.style[&#x27;WebkitTouchCallout&#x27;]=&#x27;none&#x27;;
                }else{
                    e.preventDefault();
                    e.stopPropagation();
                }
                context.dragStartIn(e.pageX,e.pageY);
                
            };
            /** @ignore */
            this.dragStartIn = function (x,y) {
                if(context.isLocked){
                    return;
                }
                //缓存高宽
                $E.notifyObservers(context, &quot;beforeStart&quot;);
                $E.notifyObservers(document, &quot;beforeStart&quot;);
//              if(this.dragType){//jet框架跟alloy耦合不好
//                  $E.notifyObservers(alloy, &quot;dragBeforeStart&quot;,this.dragType);
//              }
                _clientWidth = $D.getClientWidth(),
                _clientHeight = $D.getClientHeight();
                _workAreaWidth = option.clientEl?$D.getClientWidth(option.clientEl):_clientWidth;
                _workAreaHeight = option.clientEl?$D.getClientHeight(option.clientEl):_clientHeight;
                _width = context.effectEl ? parseInt($D.getClientWidth(context.effectEl)) : 0;
                _height = context.effectEl ? parseInt($D.getClientHeight(context.effectEl)) : 0;

                if (context.isLimited) {
                    _limit_right = _workAreaWidth - _width - context._rightMargin;
                    _limit_left = context._leftMargin;
                    _limit_top = context._topMargin;
                    _limit_bottom = _workAreaHeight - _height - context._bottomMargin;
                }
                if(!_dragMaskLayer){
                    _dragMaskLayer = new J.ui.MaskLayer({opacity: 0});
//                    _maskLayerZIndex = alloy.layout.getTopZIndex(2);
                }
                _dragMaskLayer.setZIndex(_maskLayerZIndex);
                _dragMaskLayer.show();
//                context._oldZIndex = $D.getStyle(context.effectEl, &#x27;zIndex&#x27;) || 0;
//                J.out(&#x27;dragStart - _oldZIndex: &#x27; + context._oldZIndex + &#x27;::&#x27; + _maskLayerZIndex);
//                $D.setStyle(context.effectEl, &#x27;zIndex&#x27;, _maskLayerZIndex + 1);
                
                
                context._oldX=curDragElementX = context.effectEl ? (parseInt($D.getStyle(context.effectEl, &quot;left&quot;)) || 0) : 0;
                context._oldY=curDragElementY = context.effectEl ? (parseInt($D.getStyle(context.effectEl, &quot;top&quot;)) || 0) : 0;
                dragStartX = x;
                dragStartY = y;
                if(J.browser.mobileSafari){
                    $E.on(document, &#x27;touchmove&#x27;, context.dragMove);
                    $E.on(document, &#x27;touchend&#x27;, context.dragStop);
                    
                    var oldMatrix=new WebKitCSSMatrix(window.getComputedStyle(context.apperceiveEl).webkitTransform);
                    _dragOffsetX = x - oldMatrix.m41;
                    _dragOffsetY = y - oldMatrix.m42;
                    
                }else{
                    $E.on(document, &quot;mousemove&quot;, context.dragMove);
                    $E.on(document, &quot;mouseup&quot;, context.dragStop);
                }
                if (J.browser.ie) {
                    $E.on(document.body, &quot;selectstart&quot;, ieSelectFix);
                }
                if(J.browser.mobileSafari){
                    $E.notifyObservers(context, &quot;start&quot;, { x: x, y: y });
                }else{
                    $E.notifyObservers(context, &quot;start&quot;, { x: curDragElementX, y: curDragElementY });
                }      
            };
            /** @ignore */
            this.dragMove = function (e) {
                if(context.isLocked){
                    return;
                }
                if(e.browserEvent){
                    e.browserEvent.preventDefault();
                    e.browserEvent.stopPropagation();
                }else{
                    e.preventDefault();
                    e.stopPropagation();
                }
                if(e.changedTouches){//多点触摸
                    
                    e=e.changedTouches[0];
                }
                var x,y;
                var pageX = e.pageX,
                    pageY = e.pageY;
                if(context.isLockCursorInScreen){//限制鼠标超出浏览器外
                    pageX &lt; 0 ? (pageX = 0) : (pageX &gt; _clientWidth ? (pageX = _clientWidth) : 0);
                    pageY &lt; 0 ? (pageY = 0) : (pageY &gt; _clientHeight ? (pageY = _clientHeight) : 0);
                }
                if(!J.browser.mobileSafari){
                    x = curDragElementX + (pageX - dragStartX);
                    y = curDragElementY + (pageY - dragStartY);
                }
                if (context.isLimited) {
                    if(x&gt;_limit_right &amp;&amp;!option.isOverRight ){
                        x=_limit_right;
                    }
                    if(x&lt;_limit_left &amp;&amp; !option.isOverLeft){
                        x=_limit_left;
                    }
                }
                if (context._oldX !== x&amp;&amp;!context._yOnly) {
                    context._oldX = x;
                    if (context.effectEl &amp;&amp; !J.browser.mobileSafari) {
                        context.effectEl.style.left = x + &quot;px&quot;;
                    }
                    isMoved = true;
                }
                
                //J.out(&quot;context._topMargin: &quot;+context._topMargin);
                if (context.isLimited) {
                    if (y &gt; _limit_bottom &amp;&amp; !option.isOverBottom) {
                        y = _limit_bottom;
                    }
                    if (y &lt; _limit_top &amp;&amp; !option.isOverTop) {
                        y = _limit_top;
                    }
                }

                if (context._oldY !== y&amp;&amp;!context._xOnly) {
                    context._oldY = y;
                    if (context.effectEl &amp;&amp; !J.browser.mobileSafari) {
                        context.effectEl.style.top = y + &quot;px&quot;;
                    }
                    isMoved = true;
                }
                
                //for ipad...BAD SMELL.
                var notifyX = x,
                    notifyY = y;
                if(context.effectEl &amp;&amp; J.browser.mobileSafari){
                    context._oldX = curDragElementX + (pageX - dragStartX);
                    context._oldY = curDragElementY + (pageY - dragStartY);
                    var eX = pageX,
                        eY = pageY;
                    if(!context._yOnly){
                        x = pageX - _dragOffsetX;
                    }else{
                        x = curDragElementX;
                    }
                    if(!context._xOnly){
                        y = eY - _dragOffsetY;
                    }else{
                        y = curDragElementY;
                    }
                    context.effectEl.style.webkitTransform = &#x27;translate3d(&#x27; + x + &#x27;px, &#x27; + y + &#x27;px, 0px)&#x27;;
                    notifyX = pageX;
                    notifyY = pageY;
                }


                if (isMoved) {
                    $E.notifyObservers(context, &quot;move&quot;, { x: notifyX, y: notifyY, orientEvent:e });
                }

            };
            /** @ignore */
            this.dragStop = function (e) {
                _dragMaskLayer.hide();
                if(context.isLocked){
                    return;
                }
//                J.out(&#x27;dragStop - _oldZIndex: &#x27; + context._oldZIndex);
//                $D.setStyle(context.effectEl, &#x27;zIndex&#x27;, context._oldZIndex);
                
                document.body.style[&#x27;WebkitTouchCallout&#x27;]=&#x27;auto&#x27;;
                if(isMoved || J.browser.mobileSafari) {
                    var x=context._oldX;
                    var y=context._oldY;
                    if (context.isLimited) {
                        if(x&gt;_limit_right&amp;&amp;!option.isOverRight){
                            x=_limit_right;
                        }
                        if(x&lt;_limit_left&amp;&amp;!option.isOverLeft){
                            x=_limit_left;
                        }
                    }
                    if (context.isLimited) {
                        if (y &gt; _limit_bottom&amp;&amp;!option.isOverBottom) {
                            y = _limit_bottom;
                        }
                        if (y &lt; _limit_top&amp;&amp;!option.isOverTop) {
                            y = _limit_top;
                        }
                    }
                    if(J.browser.mobileSafari){
                        e.preventDefault();
                        if(option.noEndCallback &amp;&amp; context.effectEl){
                            context.effectEl.style.webkitTransform  = &#x27;none&#x27;;
                            $D.setStyle(context.effectEl,&#x27;left&#x27;,x+&#x27;px&#x27;);
                            $D.setStyle(context.effectEl,&#x27;top&#x27;,y+&#x27;px&#x27;);
                        }
                        $E.notifyObservers(context, &quot;end&quot;, { x: x, y: y, orientEvent:e.changedTouches[0] });
                    }else{
                        $E.notifyObservers(context, &quot;end&quot;, { x: x, y: y, orientEvent:e });
                    }
                }
                else {
                    $E.notifyObservers(context, &quot;end&quot;, {orientEvent:e});
                }
                if (context.isLimited&amp;&amp;(context.isOverRight||context.isOverLeft||context.isOverTop||context.isOverBottom)) {
                    var x = curDragElementX + (e.pageX - dragStartX);
                    var y = curDragElementY + (e.pageY - dragStartY);
                    var tempR = _workAreaWidth - _width - context._rightMargin;
                    var tempL = context._leftMargin;
                    var tempB = _workAreaHeight - context._bottomMargin;
                    var tempT = context._topMargin;
                    if (x &gt; tempR||x &lt; tempL||y &gt; tempB||y &lt; tempT) {
                        //超出边界
                        $E.notifyObservers(context,&quot;overFlowBorder&quot;,{x: x,y: y});
                        //J.out(&quot;overFlow&quot;);
                    }
                }
                _workAreaWidth = false;
                _workAreaHeight = false;
                _width = false;
                _height = false;
                if(J.browser.mobileSafari){
                    $E.off(document, &#x27;touchmove&#x27;, context.dragMove);
                    $E.off(document, &#x27;touchend&#x27;, context.dragStop);
                }else{
                    $E.off(document, &quot;mousemove&quot;, context.dragMove);
                    $E.off(document, &quot;mouseup&quot;, context.dragStop);
                }
                if (J.browser.ie) {
                    $E.off(document.body, &quot;selectstart&quot;, ieSelectFix);
                }
                isMoved= false;
                //J.out(&quot;end&quot;)
            };

            //if(J.browser.mobileSafari){
            //  $E.on(this.apperceiveEl, &quot;touchstart&quot;, this.dragStart);
            //}else{
                $E.on(this.apperceiveEl, &quot;drag&quot;, this.dragStart);
            //}
        },
        /**
         * 设置展现拖拽结果的元素
         * @param {HTMLElement} el
         */
        setEffect: function(el){
            this.effectEl = el;
        },
        /**
         * 锁定拖拽
         */
        lock: function () {
            //if(J.browser.mobileSafari){
            //  $E.off(this.apperceiveEl, &quot;touchstart&quot;, this.dragStart);
            //}else{
                this.isLocked = true;
                $E.off(this.apperceiveEl, &quot;drag&quot;, this.dragStart);
            //}
        },
        /**
         * 解锁
         */
        unlock: function () {
            //if(J.platform.iPad){/
            //  $E.on(this.apperceiveEl, &quot;touchstart&quot;, this.dragStart);
            //}else{
                this.isLocked = false;
                $E.on(this.apperceiveEl, &quot;drag&quot;, this.dragStart);
            //}
        },
        /**
         * 显示监听拖拽动作的元素
         */
        show: function () {
            $D.show(this.apperceiveEl);
        },
        /**
         * 隐藏监听拖拽动作的元素
         */
        hide: function () {
            $D.hide(this.apperceiveEl);
        },
        /**
         * 设置拖拽边界
         */
        setLimite : function(option){
            option = option || {};
            this.isLimited = option.isLimited || true;
            if (this.isLimited) {
                this._leftMargin = option.leftMargin || 0;
                this._topMargin = option.topMargin || 0;
                this._rightMargin = option.rightMargin || 0;
                this._bottomMargin = option.bottomMargin || 0;
            }
        }
    });



});

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
